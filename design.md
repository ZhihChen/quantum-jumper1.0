# 量子跃迁者 - 完整关卡设计文档

## 通关条件（所有关卡通用）

**核心要求：** 收集关卡内所有能量点（量子碎片）

### 通关检测机制
- 所有收集品的 `collected` 状态必须为 `true`
- 已收集数量 > 0
- 未收集数量 = 0
- 游戏状态必须为 `'playing'`
- 关卡完成标志未被触发

### 通关流程
1. 玩家触碰能量点（绿色发光方块）→ 自动收集并播放音效
2. 每帧检测所有能量点是否收集完毕
3. 全部收集后 → 显示粒子完成效果
4. 2秒延迟后 → 自动进入下一关
5. 完成第10关后 → 显示胜利界面

---

## 关卡详细设计

### 第1关：基础教学 - 正常维度

**能量点数：** 3个  
**随机性：** 无（固定设计）  
**难度等级：** ⭐☆☆☆☆ (1/5)

**设计理念：**
- 让玩家熟悉基础操作和游戏机制
- 只使用正常维度（维度0），重力方向向下
- 简单跳跃挑战，建立基础操作手感

**关卡布局：**
- 起点平台：x=0, y=550 (底部)
- 3个跳跃平台：高度递减（450, 350, 250）
- 3个能量点：分布在平台上方

**通关条件：** 收集3个能量点

**特殊机制：** 无

---

### 第2关：引入反重力维度

**能量点数：** 3个  
**随机性：** 无（固定设计）  
**难度等级：** ⭐⭐☆☆☆ (2/5)

**设计理念：**
- 引入第二个维度：反重力维度（维度1）
- 学习在反重力模式下平台下表面站立
- 理解不同维度的平台可见性规则

**关卡布局：**
- 底部两个分离平台（正常维度）
- 中间一个反重力平台（维度1），可以从下往上站
- 上方两个正常平台
- 3个能量点：分布在反重力平台和上方平台

**通关条件：** 收集3个能量点

**特殊机制：**
- 需要切换到反重力维度（按键2）才能看到并使用中间平台
- 反重力模式下玩家向上"坠落"，可以站在平台下表面

---

### 第3关：时间扭曲与能量场维度

**能量点数：** 4个  
**随机性：** 无（固定设计）  
**难度等级：** ⭐⭐⭐☆☆ (3/5)

**设计理念：**
- 引入第三个和第四个维度：时间扭曲（维度2）和能量场（维度3）
- 学习所有四个维度的特性
- 引入危险区域机制

**关卡布局：**
- 基础平台（正常维度）
- 时间扭曲平台（维度2）：时间流速变慢
- 能量场平台（维度3）：有推动力效果
- 正常维度平台
- 危险区域：激光障碍（正常维度）
- 4个能量点：分布在不同维度平台

**通关条件：** 收集4个能量点

**特殊机制：**
- 时间扭曲维度：游戏速度变慢，给玩家更多反应时间
- 能量场维度：玩家会受到周期性推动力影响
- 危险区域：触碰会扣除20点能量

---

### 第4关：随机解谜挑战（初级）

**能量点数：** 5个（公式：3 + floor(4/2) = 5）  
**随机性：** ✅ 有（每次重启同一关会有随机变化）  
**难度等级：** ⭐⭐⭐☆☆ (3/5)

**设计理念：**
- 开始引入随机生成的复杂关卡
- 四个维度开始混合使用
- 路径设计确保可达性，所有能量点都有明确获取路径

**关卡生成参数：**
- 路径阶段数：6个（确保 ≥ 能量点数+1）
- 危险区域密度：30%
- 最终挑战区域：有
- 维度切换要求：不强制的（6关以上才强制）

**平台生成规则：**
- 主要路径平台：6个，按维度随机分布
- 最终平台：1个，补充剩余能量点
- 根据维度调整位置策略：
  - 反重力：中间偏上位置
  - 时间扭曲：适中位置
  - 能量场：随机位置，增加挑战
  - 正常：标准跳跃距离

**通关条件：** 收集5个能量点

**特殊机制：**
- 四个维度都可能用到
- 随机生成确保每次重启都有新挑战
- 难度保持相似，但布局变化

---

### 第5关：随机解谜挑战（中级）

**能量点数：** 5个（公式：3 + floor(5/2) = 5）  
**随机性：** ✅ 有  
**难度等级：** ⭐⭐⭐⭐☆ (4/5)

**设计理念：**
- 保持能量点数，但增加路径复杂度
- 危险区域密度增加到40%
- 需要更熟练的维度切换技巧

**关卡生成参数：**
- 路径阶段数：6个
- 危险区域密度：40%
- 最终挑战区域：有
- 维度切换要求：不强制的

**通关条件：** 收集5个能量点

**特殊机制：**
- 与第4关相同的能量点数，但难度提升
- 危险区域更频繁出现
- 需要更精确的操作

---

### 第6关：强制维度切换挑战

**能量点数：** 6个（公式：3 + floor(6/2) = 6）  
**随机性：** ✅ 有  
**难度等级：** ⭐⭐⭐⭐☆ (4/5)

**设计理念：**
- 强制要求使用所有四个维度
- 增加能量点数到6个
- 引入最终区域危险（40%概率）

**关卡生成参数：**
- 路径阶段数：7个
- 危险区域密度：50%
- 最终挑战区域：有（可能含危险）
- 维度切换要求：✅ **强制**（确保使用所有维度）

**平台生成规则：**
- 每隔一个阶段强制使用未使用的维度
- 确保四个维度都会被用到

**通关条件：** 收集6个能量点

**特殊机制：**
- **强制维度多样性**：必须切换使用四个维度
- 最终区域可能包含危险区域
- 需要规划维度切换顺序

---

### 第7关：辅助平台解谜

**能量点数：** 6个（公式：3 + floor(7/2) = 6）  
**随机性：** ✅ 有  
**难度等级：** ⭐⭐⭐⭐⭐ (5/5)

**设计理念：**
- 引入辅助平台机制（40%概率）
- 增加解谜选项和路径多样性
- 需要更深入的策略思考

**关卡生成参数：**
- 路径阶段数：7个
- 危险区域密度：60%
- 最终挑战区域：有（可能含危险）
- 辅助平台：✅ 有（40%概率）
- 维度切换要求：✅ 强制

**特殊机制：**
- **辅助平台**：在主要路径平台附近随机生成，提供替代路径
- 增加解谜深度：玩家可以选择不同路径
- 更复杂的维度组合挑战

**通关条件：** 收集6个能量点

---

### 第8关：高级挑战（一）

**能量点数：** 7个（公式：3 + floor(8/2) = 7）  
**随机性：** ✅ 有  
**难度等级：** ⭐⭐⭐⭐⭐ (5/5)

**设计理念：**
- 能量点数增加到7个
- 危险区域密度达到70%
- 最终区域危险出现概率提升到60%

**关卡生成参数：**
- 路径阶段数：8个
- 危险区域密度：70%
- 最终挑战区域：有（危险概率60%）
- 辅助平台：有
- 维度切换要求：✅ 强制

**通关条件：** 收集7个能量点

**特殊机制：**
- 最密集的危险区域分布
- 需要精确的时机控制
- 最高难度的反应速度要求

---

### 第9关：高级挑战（二）

**能量点数：** 7个（公式：3 + floor(9/2) = 7）  
**随机性：** ✅ 有  
**难度等级：** ⭐⭐⭐⭐⭐ (5/5)

**设计理念：**
- 保持第8关的难度水平
- 更复杂的路径布局
- 考验玩家的综合能力

**关卡生成参数：**
- 路径阶段数：8个
- 危险区域密度：70%
- 最终挑战区域：有（危险概率60%）
- 辅助平台：有
- 维度切换要求：✅ 强制

**通关条件：** 收集7个能量点

**特殊机制：**
- 与第8关难度相当
- 随机性确保新的挑战布局

---

### 第10关：终极挑战

**能量点数：** 8个（公式：3 + floor(10/2) = 8）  
**随机性：** ✅ 有  
**难度等级：** ⭐⭐⭐⭐⭐ (5/5)

**设计理念：**
- 最高能量点数：8个
- 最复杂的路径布局：9个阶段
- 最高危险区域密度：70%
- 考验玩家的终极能力

**关卡生成参数：**
- 路径阶段数：9个（最多）
- 危险区域密度：70%（最高）
- 最终挑战区域：有（危险概率60%）
- 辅助平台：有
- 维度切换要求：✅ 强制

**通关条件：** 收集8个能量点

**特殊机制：**
- 最长的关卡路径
- 最多的能量点数
- 最密集的危险区域
- 需要完美掌握所有四个维度

---

## 难度递进曲线

### 能量点数递进
- 1-3关：3, 3, 4个（固定，教学）
- 4-5关：5, 5个（入门随机）
- 6-7关：6, 6个（中级随机）
- 8-9关：7, 7个（高级随机）
- 10关：8个（终极挑战）

### 难度参数对比表

| 关卡 | 能量点 | 路径阶段 | 危险密度 | 最终危险 | 辅助平台 | 强制维度 | 随机性 |
|------|--------|----------|----------|----------|----------|----------|--------|
| 1 | 3 | 4 | 0% | ❌ | ❌ | ❌ | ❌ |
| 2 | 3 | 5 | 0% | ❌ | ❌ | ❌ | ❌ |
| 3 | 4 | 5 | 1个固定 | ❌ | ❌ | ❌ | ❌ |
| 4 | 5 | 6 | 30% | ❌ | ❌ | ❌ | ✅ |
| 5 | 5 | 6 | 40% | ❌ | ❌ | ❌ | ✅ |
| 6 | 6 | 7 | 50% | 40% | ❌ | ✅ | ✅ |
| 7 | 6 | 7 | 60% | 40% | ✅ | ✅ | ✅ |
| 8 | 7 | 8 | 70% | 60% | ✅ | ✅ | ✅ |
| 9 | 7 | 8 | 70% | 60% | ✅ | ✅ | ✅ |
| 10 | 8 | 9 | 70% | 60% | ✅ | ✅ | ✅ |

---

## 随机性机制（4-10关）

### 随机变化触发条件
- **每次能量耗尽重启同一关时**：关卡布局会随机变化
- **使用种子随机数生成器**：基于关卡号和重启次数生成唯一种子
- **时间戳辅助**：确保每次加载都有所不同

### 随机化元素
1. **平台位置**：在保证可达性的前提下随机分布
2. **平台维度**：随机分配四个维度
3. **平台大小**：70-120像素宽度随机
4. **危险区域位置**：根据密度随机生成
5. **辅助平台**：随机位置和维度
6. **最终平台位置**：随机生成

### 确保可解性
- **路径验证**：确保所有平台都有连接路径
- **收集品可达性**：所有能量点都有明确的获取路径
- **难度平衡**：随机变化后难度保持相似

---

## 修复的Bug总结

### 已修复的问题
1. ✅ **收集品数量不足**：修复了生成逻辑，确保每关都有正确数量的能量点
2. ✅ **收集品生成条件**：改为 `collectibles.length < numCollectibles` 而非 `i < numCollectibles`
3. ✅ **路径阶段数不足**：确保 `pathStages >= numCollectibles + 1`
4. ✅ **多重保障机制**：添加了4层保障确保收集品数量正确
5. ✅ **调试信息完善**：添加详细日志便于排查问题

### 保障机制层次
1. **第一层**：主要路径循环中生成收集品
2. **第二层**：最终平台补充收集品
3. **第三层**：while循环补充收集品到目标数量
4. **第四层**：强制验证并补充到基础平台（最后保障）

---

## 游戏完整性验证

### 关卡流程完整性
✅ 第1关 → 第2关 → ... → 第10关 → 胜利界面

### 通关逻辑完整性
✅ 每关都有明确的收集品数量  
✅ 每关都有路径验证确保可达  
✅ 每关完成检测逻辑正确  
✅ 关卡切换机制完善  

### 难度设计完整性
✅ 1-3关：基础教学，无随机  
✅ 4-10关：难度递增，有随机  
✅ 能量点数递增合理  
✅ 危险区域密度递增合理  

---

## 总结

所有关卡现在都经过完整设计和验证：
- **能量点数**：每关都有明确且正确的数量
- **通关条件**：统一且清晰的收集所有能量点
- **难度递进**：从简单到复杂的合理曲线
- **随机性**：4-10关有随机变化但不影响可解性
- **完整性**：从第1关到第10关的完整流程
